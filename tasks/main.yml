---

# tasks file for ansible-k8s-deploy
#

#- name: PV and PVC NFS template upload
#  template:
#    src: "nfs-pv-pvc.yaml.j2"
#    dest: "/home/{{ provision_cluster_user }}"
#    owner: "{{ provision_cluster_user }}"
#    group: wheel
#    mode: '0644'


- name: install python docker sdk for ansible modules
  command: "pip install docker"

- name: install openshift
  command: "pip install openshift"

- name: Create Docker private registry
  include_tasks: docker_private_reg.yml

    #- name: Sleep for 200 seconds and continue with play
    #  wait_for:
    #    timeout: 200
    #  delegate_to: localhost

- name: Docker configuration
  include_tasks: docker_conf.yml

- name: Create hellogo deployment from an inline definition
  #community.kubernetes.k8s:
  k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: hello-go
        namespace: default
        labels:
          app: hello-go
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: hello-go
        template:
          metadata:
            labels:
              app: hello-go
          spec:
            containers:
              - name: hello-go
                imagePullPolicy: IfNotPresent
                #image: 192.168.130.150:5000/hello-go:latest
                image: master:31320/hello-go:latest
                ports:
                - containerPort: 8180
                  # imagePullSecrets:
                  # - name: regcred


- name: Create a Service object from an inline definition
  #community.kubernetes.k8s:
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: hello-go-service
        namespace: default
        labels:
          app: hello-go
          service: web
      spec:
        type: LoadBalancer
        selector:
          app: hello-go
          service: web
        ports:
        - protocol: TCP
          targetPort: 8180
          name: port-8180-tcp
          port: 8180


            #- name: Allow ALL at iptables
            #  shell: |
            #    iptables -P INPUT ACCEPT
            #    iptables -P FORWARD ACCEPT
            #    iptables -P OUTPUT ACCEPT
            #    iptables -t nat -F
            #    iptables -t mangle -F
            #    iptables -F
            #    iptables -X
            #  become: yes

